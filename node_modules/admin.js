var express = require('express');
var df = require('dateformat');
var passport = require('passport');
var router = express.Router();
var mysql = require('mysql');
var cfg = require('config');
var sqlhelper = require('mysqlhelper2');
var mailer = require('nodemailer');
var messageService;

/// START ROUTE HP ADMIN (/)

router.get("/index.html", function (req, resp) {
    // Si le user is defined 
    if (typeof req.user !== 'undefined') {
    // Rendu du twig avec les données username
        resp.render("admin/index.html.twig", {"username": req.user.username });
    }
    	// Sinon renvoi à la page login pour authentification
	    else {
	        resp.redirect("/login.html");
	    }
});

/// END ROUTE HP ADMIN (/)

/// START ROUTE INDEX 

router.get("/", function (req, resp) {
    // Route des "/admin" et redirige sur la route principale de admin
    resp.redirect("/admin/index.html");
});

/// END ROUTE INDEX 

/// START ROUTE LOGOUT ADMIN

router.get("/logout.html", function (req, resp) {
    // Fin de la session de connexion
    req.logout();
    // Redirection "/"
    resp.redirect("/");
});

/// END ROUTE LOGOUT ADMIN

/// START ROUTE DATA TABLES GESTION DES MAILS

router.get("/message.html", function(req,resp) {
    // Variable message
    var message = null;
    // On sélectionne tous les messages de la table cyrcontact_form
    sqlhelper.pool.query("SELECT * FROM cyrcontact_form", function(err, rows, fields){
        //console.log("err :" + err);
        //si il y a une erreur donc si la valeur err est differente de null
        if (err != null) {
            //console.log(message + ' ----- ' + err);
        }
	        else {
	            //sinon il n'y a pas d'erreur donc on ajoute la nouvelle valeur au message
	            //message = "La recuperation des données c'est bien passé ";
	            //on log pour voir le mesage si il passe
	            //console.log('message bien reussi avec le message : ' + message);
	        }
	        //on log pour voir le mesage si il passe en fin de connection
	        //console.log('connection end ' + message);
	        //fin de connection    
	
	        	//si le user est loggué
		        if (typeof req.user !== 'undefined') {
		            //alors je renvoie le twig avec username et le tableau des mails à afficher
		            resp.render("admin/message.html.twig", { "username": req.user.username,"form_email": rows });
		        }
		        	//sinon je renvoie le user a la page login pour authentification
			        else {
			            resp.redirect("/login.html");
			        }
    });
});

/// END ROUTE ROUTE DATA TABLES GESTION DES MAILS

/// START ROUTE TRAITEMENT DES MAILS

router.get("/modifmessage/:id/:email", function (req,resp) {
    //on initialise la variable message à null
    var message = null;
    var id = req.params.id;
    var lastEmail = req.params.email;
    //Alors on passe second query pour la modification d'un message recuperé par son id
    sqlhelper.pool.query("UPDATE `cyrcontact_form` SET `emailnotification` = 1 WHERE `cyrcontact_form`.`id` = ?",[id],function(err, rows, fields){
    	var lastEmail = req.params.email;
        console.log('RECUPERATION MAIL---------->' + lastEmail);
    	//function qui renvoie une erreur si il y a un probleme
            // on verifie dans la console le valeur de err pour voir si il y a une erreur
            //console.log("err :" + err);
            //si il y a une erreur donc si la valeur err est differente de null
            if (err != null) {
                //on enregistre le message d'erreur'
                //message = "Il y a eu une erreur dans la query";
                //on log pour voir le mesage si il passe
                //console.log(message + ' ----- ' + err);
                
            }
            else {
                //sinon il n'y a pas d'erreur donc on ajoute la nouvelle valeur au message
                //message = "La recuperation des données c'est bien passé ";
                //on log pour voir le mesage si il passe
                //console.log('message bien reussi avec le message : ' + message);
                //si le user enregistré en session est different de nul (typeof verifi le type de donné)
	            if (typeof req.user !== 'undefined'){
	                //alors je renvoie le twig avec un tablo qui recupere les elements de username
	            	resp.redirect("/admin/message.html");
	            	
/// START ENVOI 2ème MAIL	            	
	            console.log('/// START ENVOI 2ème MAIL');				
				 var transporter = mailer.createTransport('smtps://'+cfg.MAIL.smtpuser+'%40gmail.com:'+cfg.MAIL.smtppassword+'@smtp.gmail.com');
	             var mailoptions ={                    
	                     from :"cyril.maipee@gmail.com",
	                     // Email: email récupéré
	                     to :lastEmail,                    
	                     Subject :"Nous avons bien reçu votre demande ",
	                     // Format texte
	                     text :"Bonjour, Nous vous remercions pour  votre confiance, votre demande vient d’être traitée par notre équipe et aurez de nos nouvelles dans les plus brefs délais.",
	                     // Format html
	                     html :"<p>Bonjour, Nous vous remercions pour  votre confiance, votre demande vient d’être traitée par notre équipe et aurez de nos nouvelles dans les plus brefs délais.</p>"
	                     // Option obligatoire
	             }
	             transporter.sendMail(mailoptions,function(err,info){
	            	 
	                 // Si j'ai une erreur, je l'écris dans la console. Le "return" permet de sortir de la fonction et de ne pas afficher la suite
	                 if(err!= null) return console.log('ECHEC 2ème ENVOI MAIL DE CONFIRMATION DE TRAITEMENT DE LA DEMANDE -----> '+err);
		                 else{
		                	 console.log('REUSSITE 2ème ENVOI MAIL DE CONFIRMATION DE TRAITEMENT DE LA DEMANDE -----> ');
		                	 console.log('/// END ENVOI 2ème MAIL');	
		                 }	                	         			
	             });	            
	             // Fermeture de la connexion smtps
	             transporter.close();
	             resp.status(200).end(''+message);		           
/// END ENVOI 2ème MAIL		            	
	            }
	            	//sinon je renvoie le user a la page login pour authentification
		            else {
		                resp.redirect("/login.html");
		            }         
        }
    });   
});

/// END ROUTE TRAITEMENT DES MAILS

// Exportation du module
module.exports = router;
