var mysql = require('mysql');
var express = require('express');
var app = express();
var passport = require('passport');
var ls = require('passport-local').Strategy;
var mysqlhelper = require('mysqlhelper2');
var dbuser = null;
	
//on serialise l'objet user à l'ouverture de la session
passport.serializeUser(function(user,done){
	done(null,user.id);
});

//on le deserialise à la fermeture de la session
passport.deserializeUser(function(id,done){
	done(null,dbuser);
});

//on utilise le module passport pour gérer la connexion
passport.use('local-login',new ls(function(username,password,done){
	//on fait une boucle qui va parcourir le tableau de users créé plus haut
	//s'il trouve un équivalent username + mdp
	//alors on charge dbuseravec ses informations.
	//@TODO sécuriser la query
	mysqlhelper.pool.query('SELECT * FROM cyrapp_users',function(err,rows,fields){
		if(!err)
		{
			if(rows.length>0)
			{
				for(var i=0;i<rows.length;i++)
				{
					if(username==rows[i].username)
					{
						dbuser=rows[i];
					}
				}
			}
				else
				{
					console.log(err);		
				}
		}
		console.log('AUTHENTIFICATION DB USER close');
		console.log('AUTHENTIFICATION DB USER : '+username);
		if(dbuser != null)
		{
			return done(null,dbuser);
		}
			else
			{	//@TODO faire passer en log un message si échec de l'authentification
				return done(null,false,{"message":"pas de user"});
				console.log('AUTHENTIFICATION DB USER FALSE: '+username);
			}
	});
}));
