var express = require('express');
var router = express.Router();
var mysql = require('mysql');
var dateformat = require('dateformat');
var passport = require('passport');
var cfg = require('config');
var mysqlhelper = require('mysqlhelper2');
var mailer = require('nodemailer');

router.get("/",function(req,resp){
	resp.redirect("/index.html");
});

router.get("/index.html",function(req,resp){
	resp.render("web/index.html.twig");
});

/// START "CONTACT"

	/// GET
router.get("/contact.html",function(req,resp){
	resp.render("web/contact.html.twig");
});

	/// POST
router.post("/contact.html",function(req,resp){
	//var tot= total(req);
	// Initialisation var message vide pour gestion du feed-back utilisateur
	var message = '';
	
	// Récupération du nom dans la variable name
	var name = req.body.name;
	console.log(" ---------- START ENVOI FORM ----------> verifName : "+name);	
	
	// Vérification du nom
	function verifName(name){
		console.log("verifName : "+name+"length : "+name.length);
		
		if(name.length < 2 || name.length > 32){
			console.log("verifName false"+name);
			message = "Veuillez insérer un nom valide";
			return false;
		}
			else
			{
				console.log("verifName true"+name);
				return true;
			}
	}
	
	// Récupération de l'email dans la variable email
	var email = req.body.email;

	 console.log('RECUPERATION MAIL---------->' + email);
	
	// Vérification de l'email
	function verifEmail(email){
			var regex = /^[a-zA-Z0-9._-]+@[a-z0-9._-]{2,}\.[a-z]{2,4}$/;
			console.log("verifemail : "+email);
			if(!regex.test(email))
			{
				console.log("verifemail false : "+email);
				message =message+"<br />" + " Veuillez insérer un email valide";
				return false;
			}
				else
				{
					console.log("verifemail true : "+email);
					return true;
				}
	}
	// Récupération du sujet dans la variable subject
	var subject = req.body.subject;
	
	// Vérification du sujet
	function verifsujet(subject){
		console.log("verifsubject : "+subject);
		if(subject.length < 2 || subject.length > 200 ){
			console.log("verifsubject false : "+subject);
			message = message + " <br />Veuillez remplir le sujet ";
			return false;
		}
			else
			{
				console.log("verifsubject true : "+subject);
				return true;
			}		
	}

	var verifNameOk=verifName(name);
	var verifEmailOk=verifEmail(email);
	var verifsujetOk=verifsujet(subject);
	console.log("verifNameOk "+verifNameOk);
	console.log("verifEmailOk "+verifEmailOk);
	console.log("verifsujetOk "+verifsujetOk);

	// Si vérifications OK
	if(verifNameOk && verifEmailOk && verifsujetOk){
			// Sécurisation de la query
			var sql ="INSERT INTO `cyrcontact_form` (`name`, `email`, `subject`, `emailnotification`) VALUES (?, ?, ?, ?);"	
			// Insertion en DB
			mysqlhelper.pool.query(sql,[name,email,subject, 0],function(err,rows,fields){
			
		// Si il y a une erreur...
		if(err != null)
		{	//...message erreur		
			message = "Il y a eu une erreur, le message n'a pas été envoyé";
			console.log('ECHEC ENVOI FORMULAIRE ---> '+message + ' ' + err);
		}
		// Sinon, message réussite et envoi du mail de bonne réception du formulaire à l'utilisateur (Simulation avec mon mail)
			else
			{				
				 var transporter = mailer.createTransport('smtps://'+cfg.MAIL.smtpuser+'%40gmail.com:'+cfg.MAIL.smtppassword+'@smtp.gmail.com');
	             var mailoptions ={                    
	                     from :"cyril.maipee@gmail.com",
	                     // Email: email récupéré dans le body
	                     to :email,                    
	                     Subject :"Nous avons bien reçu votre demande ",
	                     // Format texte
	                     text :"Bonjour, Nous vous remercions pour  votre confiance, votre demande vient d’être traitée par notre équipe et aurez de nos nouvelles dans les plus brefs délais.L’équipe Coffee-cup",
	                     // Format html
	                     html :"<p>Bonjour,<br /> Nous vous remercions pour  votre confiance, votre demande vient d’être traitée par notre équipe et aurez de nos nouvelles dans les plus brefs délais.<br />L’équipe Coffee-cup</p>"
	                     // Option obligatoire
	             }
	             transporter.sendMail(mailoptions,function(err,info){
	     			var last_id = rows.insertId;
	    			console.log('RECUPERATION DE ID ---> '+rows.insertId); 	            	 
	                 // Si j'ai une erreur, je l'écris dans la console. Le "return" permet de sortir de la fonction et de ne pas afficher la suite
	                 if(err!= null) return console.log('ECHEC ENVOI MAIL DE CONFIRMATION DE BONNE RECEPTION DU MESSAGE VIA LE FORMULAIRE -----> '+err);
		                 else{
		                	 // Envoi mail OK insertion statut envoyé (1)
			                 console.log('REUSSITE ENVOI MAIL DE CONFIRMATION DE BONNE RECEPTION DU MESSAGE VIA LE FORMULAIRE ---> ');
			                 // Sécurisation de la query
			                 var sql ="UPDATE `cyrcontact_form` SET emailnotification = ? WHERE ? = LAST_INSERT_ID()";	
			         			// Insertion en DB
			         			mysqlhelper.pool.query(sql,[1,last_id],function(err,rows,fields){			         			
						         		// Si il y a une erreur, message erreur
						         		if(err != null)
						         		{									         			
						         			console.log('ECHEC UPDATE TABLE cyrcontact_form cght statut 1 --->  ' + err);
						         		}
			         			});			                 
		                 }	                	         			
	             });	            
	             // Fermeture de la connexion smtps
	             transporter.close(); 	            				
			}		
			message="Votre message a bien été envoyé ! ";
			console.log('MESSAGE USER REUSSITE ENVOI FORM --->' +message);
			resp.status(200).end(''+message);		
	});

	}
		else{
		console.log(message);
		resp.status(200).end(message);
		console.log(" ---------- END ENVOI FORM ---------->");	
		}	
});

/// END "CONTACT"

/// START "BLOG"

router.get("/blog.html",function(req,resp){
	resp.render("web/blog.html.twig");
});

/// END "BLOG"

/// START "ABOUT"

router.get("/about.html",function(req,resp){
	resp.render("web/about.html.twig");
});

/// END "ABOUT"

/// START "LOGIN"

router.get("/login.html",function(req,resp){

	if(typeof req.user !== 'undefined')
	{
		resp.render("web/login.html.twig",{"username":req.user.username});
	}
		else
		{
			resp.render("web/login.html.twig");
		}
});

/// END "LOGIN"

/// START ROUTE LOGIN APRES IDENTIFICATION
	// Avec le module "passport" 
router.post("/login.html",passport.authenticate('local-login',{successRedirect:"admin/index.html",failureRedirect:"/login.html"}));


//@TODO  http://passportjs.org/docs#flash-messages
//passport.authenticate('local-login', { failureFlash: 'Invalid username or password.' });
//passport.authenticate('local-login', { successFlash: 'Welcome!' });
//var message = req.flash();
//console.log(message);

// END ROUTE LOGIN APRES IDENTIFICATION

// START ROUTE LOGOUT

router.get("/logout.html",function(req,resp){
	req.logout();
	resp.redirect('index.html');
	
});

/// END ROUTE LOGOUT

/// START "404"

router.get("/404.html",function(req,resp){	
		resp.render("404.html.twig");	
});

/// END "404"

module.exports = router;
